<!DOCTYPE html> 
<html> 
  <head> 
  <title>Page Title</title> 
  
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a1/jquery.mobile-1.0a1.min.css" />
  <link rel="stylesheet" href="css/mobiscroll-1.5.2.css" type="text/css" />
  <link rel="stylesheet" href="css/styles.css" />
  
  <script src="http://code.jquery.com/jquery-1.4.3.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.0a1/jquery.mobile-1.0a1.min.js"></script>
  
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript" src="js/jquery.fn.gmap.min.js"></script>
  <script type="text/javascript" src="js/jquery.ui.map.extensions.js"></script>
  
  <script type="text/javascript" src="js/mobiscroll-1.5.2.js"></script>
	
  
</head> 
<body> 

<img src="images/background.png" id="backgroundImage" />

<div data-role="page" id="home" data-theme="g" >
   
	<div data-role="content">
		
		<img src="pretend_logo_resource/taxico.png" id="logo" />	
		 
	    <h2 style="padding: 1em 0;">Booking Details:</h2>
			
		<ul data-role="listview" data-inset="true">
			<li>
				<a href="#pick_up">Pickup:</a>
				<p id="pick_up_button" class="split_button_text">Finding Address..</p>	
			</li>
			<li>
				<a href="#drop_off">Drop Off:</a>
				<p id="drop_off_button" class="split_button_text"></p>	
			</li>
			<li>
				<a href="#when">When:</a>
				<p id="when_button" class="split_button_text"></p>
			</li>
			
		</ul>
		
	</div>
	 
</div>


<div data-role="page" id="pick_up">

	<div data-role="header"><h1 id="status">Pick-up Location</h1></div>
	
	<div data-role="content"> 
		
		<label for="pick_up_address">Enter your pick-up location</label>
		<input type="text" name="pick_up_address" id="pick_up_address_input" value=""  />
		
		<div id="pick_up_addresses" class="inset_list"></div>

	</div>	
	
</div>



<div data-role="page" id="drop_off">

	<div data-role="header"><h1 id="status">Drop-off Location</h1></div>
	
	<div data-role="content"> 
		
		<label for="drop_off_address">Enter your drop-off location</label>
		<input type="text" name="drop_off_address" id="drop_off_address_input" value=""  />
		
		<div id="drop_off_addresses" class="inset_list"></div>

	</div>	
	
</div>


<div data-role="page" id="when">

	<div data-role="header"><h1 id="status">Pick-up time</h1></div>
	
	<div data-role="content"> 
		
		<div data-role="fieldcontain">
            <label for="date3">Datetime</label>
            <input type="text" name="date3" id="date3" class="mobiscroll" />
        </div>
		
		
	</div>	
	
</div>

<div id="tracking" data-role="page" data-theme="b" class="page-map" style="width:100%; height:100%;">
	
	<div data-role="header"><h1 id="status">Status: With Dispatcher</h1></div>
	
	<div data-role="content" class="item"> 
		<div id="map_canvas"></div>
	</div>
	
</div>


<script type="text/javascript">

var vWorkTaxico = vWorkTaxico || {};

(function() {

	this.lookup = function(address,target, callback){

		var geocoder = new google.maps.Geocoder();
		var addressList = '<p>Please broaden your search</p>';

		if (geocoder) {
			geocoder.geocode({ 'address': address }, function (results, status) {
				if (status == google.maps.GeocoderStatus.OK) {
									
					addressList = '<ul id="'+target+'" data-role="listview" data-inset="true" data-theme="c" data-dividertheme="d">'; 
					var result;
					
					for (var i = 0; i < results.length; i++){
						addressList +=	'<li><a href="#home">'+results[i].formatted_address+'</a></li>';
					};
					
					addressList += "</ul>";	

				}
				callback(addressList);
			});
		}
		
	}

	this.drop_off_lookup = function(address){
	
		$("#drop_off_addresses").empty();
		
		vWorkTaxico.lookup(address, 'drop_off_address_list',
			function(result){
				$("#drop_off_addresses").append(result);
				$("#drop_off_address_list").listview();
				
				$("#drop_off_address_list").click(function(event){
				console.log(event);
					$("#drop_off_button").text(event.target.textContent);
				});
			}
		);
	}
	
	this.pick_up_lookup = function(address){
	
		$("#pick_up_addresses").empty();
		
		vWorkTaxico.lookup(address, 'pick_up_address_list',
			function(result){
				$("#pick_up_addresses").append(result);
				$("#pick_up_address_list").listview();
				
				$("#pick_up_address_list").click(function(event){
					$("#pick_up_button").text(event.target.textContent);
				});
			}
		);
	}
	
	this.initalise = function(){
		$("#logo").width($(window).width() - 60);
		$("#backgroundImage").width($(window).width());
	}
	
	this.setDefaults = function(){
		$('#when_button').text('Right Now');		
	}
	
		
}).apply(vWorkTaxico);
		
	
$('#drop_off_address_input').data('timeout', null).keyup(function(){

    clearTimeout($(this).data('timeout'));

    $(this).data('timeout', setTimeout(function(){
        vWorkTaxico.drop_off_lookup($('#drop_off_address_input').val());

    }, 1000));

}); 

$('#pick_up_address_input').data('timeout', null).keyup(function(){

    clearTimeout($(this).data('timeout'));

    $(this).data('timeout', setTimeout(function(){
        vWorkTaxico.pick_up_lookup($('#pick_up_address_input').val());

    }, 1000));

}); 




$('#home').live("pageshow", function() {
	//$('#map_canvas').gmap('refresh');
	vWorkTaxico.setDefaults();
	vWorkTaxico.initalise();
	//$('#date3').scroller();
});


$('#home').live("pagecreate", function() {
	

	$('#map_canvas').gmap({'center': '59.3426606750, 18.0736160278', 'mapTypeId':  google.maps.MapTypeId.ROADMAP}).bind('init', function(evt, map) {
		$('#map_canvas').gmap('watchPosition', function(position, status) {
			
			console.log('watch position has status '+status);
			
			if ( status === 'OK' ) {
				var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
									
				var marker = $('#map_canvas').gmap('get', 'markers > client' );
				if ( !marker ) {
					$('#map_canvas').gmap('addMarker', { 'id': 'client', 'position': latlng, 'bounds': true });
				} else {
					marker.setPosition(latlng);
					map.panTo(latlng);
					getGeoData(marker);
				}					
			}
		});
		
	});
	
	
});

$('#home').live("pagehide", function() {
	$('#map_canvas').gmap('clearWatch');
})







	
	
// BELOW THIS LINE: unsorted geo-bric-a-brac ---------------------------------------------------------------------------------------------------------
	
	
function getGeoData(marker) {
    
    $('#map_canvas').gmap('search', { 'location': marker.getPosition() }, function(found, results) {
        if ( found ) {
            var addr = found[0].formatted_address.split(', ', 4);
            $('#pick_up_button').text(addr[0] + ', ' + addr[1] + ', ' + addr[2] + ', ' + addr[3]);                         
        } else {
            alert('Unable to get GeoSearch data.');
        }
    });
}






;
	
	
	
	

	
</script>





 
</body>
</html>