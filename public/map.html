<!DOCTYPE html> 
<html> 
  <head> 
  <title>Page Title</title> 
  
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a1/jquery.mobile-1.0a1.min.css" />
  <link rel="stylesheet" href="css/mobiscroll-1.5.2.css" type="text/css" />
  <link rel="stylesheet" href="css/styles.css" />
  
  <!-- remote -->
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.6.4.min.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/mobile/1.0rc2/jquery.mobile-1.0rc2.min.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <!-- vendor -->
  <script type="text/javascript" src="js/vendor/jquery.fn.gmap.min.js"></script>
  <script type="text/javascript" src="js/vendor/jquery.ui.map.extensions.js"></script>
  <script type="text/javascript" src="js/vendor/mobiscroll-1.5.2.js"></script>
  <!-- vWorkApp -->
  <script type="text/javascript" src="js/vWorkApp/vWorkAppGeo-1.0.0.js"></script>
  <script type="text/javascript" src="js/vWorkApp/vWorkAppUI-1.0.0.js"></script>
  
</head> 
<body> 


<div id="tracking" data-role="page" data-theme="b" class="page-map" style="width:100%; height:100%;">
	
	<div data-role="header"><h1 id="status">Status: With Dispatcher</h1></div>
	
	<div data-role="content" class="item"> 
		<div id="map_canvas"></div>
	</div>
	
</div>


<script type="text/javascript">

$('#home').live("pagecreate", function() {
	

	$('#map_canvas').gmap({'center': '59.3426606750, 18.0736160278', 'mapTypeId':  google.maps.MapTypeId.ROADMAP}).bind('init', function(evt, map) {
		$('#map_canvas').gmap('watchPosition', function(position, status) {
			
			console.log('watch position has status '+status);
			
			if ( status === 'OK' ) {
				var latlng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
									
				var marker = $('#map_canvas').gmap('get', 'markers > client' );
				if ( !marker ) {
					$('#map_canvas').gmap('addMarker', { 'id': 'client', 'position': latlng, 'bounds': true });
				} else {
					marker.setPosition(latlng);
					map.panTo(latlng);
					getGeoData(marker);
				}					
			}
		});
		
	});
	
	
});

$('#home').live("pagehide", function() {
	$('#map_canvas').gmap('clearWatch');
})

	
// BELOW THIS LINE: unsorted geo-bric-a-brac ---------------------------------------------------------------------------------------------------------
	
	
function getGeoData(marker) {
    
    $('#map_canvas').gmap('search', { 'location': marker.getPosition() }, function(found, results) {
        if ( found ) {
            var addr = found[0].formatted_address.split(', ', 4);
            $('#pick_up_button').text(addr[0] + ', ' + addr[1] + ', ' + addr[2] + ', ' + addr[3]);                         
        } else {
            alert('Unable to get GeoSearch data.');
        }
    });
}


</script>

</body>
</html>
